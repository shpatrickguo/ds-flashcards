name: Update Requirements

on:
  push:
    branches:
      - main
    paths:
      - '**.py'
  workflow_dispatch:

jobs:
  update-requirements:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          
      - name: Install pipreqs and packaging
        run: |
          pip install pipreqs packaging
          
      - name: Generate requirements.txt
        run: |
          # Generate new requirements.txt based on imports
          pipreqs . --force
          
          # Remove duplicate entries and sort (keep the highest version for duplicates)
          python3 << 'EOF'
          import re
          from packaging import version
          
          # Read requirements
          with open('requirements.txt', 'r') as f:
              lines = f.readlines()
          
          # Parse requirements
          packages = {}
          for line in lines:
              line = line.strip()
              if line and not line.startswith('#'):
                  match = re.match(r'^([a-zA-Z0-9_-]+)([>=<~!]+)(.+)$', line)
                  if match:
                      pkg_name, operator, pkg_version = match.groups()
                      pkg_name_lower = pkg_name.lower()
                      
                      # Keep the highest version if duplicate
                      if pkg_name_lower in packages:
                          existing_version = packages[pkg_name_lower]['version']
                          try:
                              if version.parse(pkg_version) > version.parse(existing_version):
                                  packages[pkg_name_lower] = {
                                      'name': pkg_name,
                                      'operator': operator,
                                      'version': pkg_version
                                  }
                          except:
                              pass  # Keep existing if version comparison fails
                      else:
                          packages[pkg_name_lower] = {
                              'name': pkg_name,
                              'operator': operator,
                              'version': pkg_version
                          }
          
          # Write deduplicated and sorted requirements
          with open('requirements.txt', 'w') as f:
              for pkg_lower in sorted(packages.keys()):
                  pkg = packages[pkg_lower]
                  f.write(f"{pkg['name']}{pkg['operator']}{pkg['version']}\n")
          EOF
          
      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet requirements.txt; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
          
      - name: Commit and push if changed
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add requirements.txt
          git commit -m "chore: auto-update requirements.txt based on imports"
          git push
