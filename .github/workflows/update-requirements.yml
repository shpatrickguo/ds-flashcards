name: Update Requirements

on:
  push:
    branches:
      - main
    paths:
      - '**.py'
  workflow_dispatch:

jobs:
  update-requirements:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          
      - name: Install pipreqs and packaging
        run: |
          pip install pipreqs packaging
          
      - name: Generate requirements.txt
        run: |
          # Generate new requirements.txt based on imports
          pipreqs . --force
          
          # Remove duplicate entries and sort (keep the highest version for duplicates)
          python3 << 'EOF'
          from packaging.requirements import Requirement, InvalidRequirement
          from packaging.version import Version, InvalidVersion
          
          # Read requirements
          with open('requirements.txt', 'r') as f:
              lines = f.readlines()
          
          # Parse requirements
          packages = {}
          for line in lines:
              line = line.strip()
              if line and not line.startswith('#'):
                  try:
                      req = Requirement(line)
                      pkg_name_lower = req.name.lower()
                      
                      # Extract version from specifier
                      pkg_version = None
                      operator = None
                      for spec in req.specifier:
                          operator = spec.operator
                          pkg_version = spec.version
                          break
                      
                      # Handle packages with or without version specifiers
                      if pkg_version and operator:
                          # Keep the highest version if duplicate
                          if pkg_name_lower in packages:
                              existing = packages[pkg_name_lower]
                              # Only compare if both have versions
                              if existing.get('version'):
                                  try:
                                      if Version(pkg_version) > Version(existing['version']):
                                          packages[pkg_name_lower] = {
                                              'name': req.name,
                                              'operator': operator,
                                              'version': pkg_version
                                          }
                                  except InvalidVersion:
                                      # Keep existing if version comparison fails
                                      pass
                          else:
                              packages[pkg_name_lower] = {
                                  'name': req.name,
                                  'operator': operator,
                                  'version': pkg_version
                              }
                      else:
                          # Package without version specifier
                          if pkg_name_lower not in packages:
                              packages[pkg_name_lower] = {
                                  'name': req.name,
                                  'operator': None,
                                  'version': None
                              }
                  except InvalidRequirement as e:
                      # Skip lines that cannot be parsed
                      print(f"Warning: Could not parse requirement '{line}': {e}")
                      continue
          
          # Write deduplicated and sorted requirements
          with open('requirements.txt', 'w') as f:
              for pkg_lower in sorted(packages.keys()):
                  pkg = packages[pkg_lower]
                  if pkg['operator'] and pkg['version']:
                      f.write(f"{pkg['name']}{pkg['operator']}{pkg['version']}\n")
                  else:
                      f.write(f"{pkg['name']}\n")
          EOF
          
      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet requirements.txt; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
          
      - name: Commit and push if changed
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add requirements.txt
          git commit -m "chore: auto-update requirements.txt based on imports"
          git push
